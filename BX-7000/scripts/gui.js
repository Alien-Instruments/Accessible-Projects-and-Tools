export const PRESETS = {
  Bass: {
    "Later on Bass": {
      algorithm: 5,
      glide: 0,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 1,
          detune: 0,
          level: 1.0,
          attack: 0.01,
          release: 0.5,
          feedback: 0.7,
          pitchAmount: -6,
          pitchAttack: 0.02,
          pitchRelease: 0.1,
        },
        {
          ratio: 1,
          detune: 0,
          level: 0.8,
          attack: 0.01,
          release: 0.5,
          feedback: 0,
        },
        {
          ratio: 2,
          detune: 0,
          level: 0.6,
          attack: 0.01,
          release: 0.4,
          feedback: 0,
        },
        {
          ratio: 3,
          detune: 0,
          level: 0.4,
          attack: 0.01,
          release: 0.4,
          feedback: 0,
        },
        {
          ratio: 6,
          detune: 0,
          level: 0.3,
          attack: 0.01,
          release: 0.3,
          feedback: 0,
        },
        {
          ratio: 0.5,
          detune: 0,
          level: 0.2,
          attack: 0.01,
          release: 0.3,
          feedback: 0,
        },
      ],
    },
    "Liquid FM Bass": {
      algorithm: 5,
      glide: 0,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 0.5,
          detune: 0,
          level: 1,
          attack: 0.01,
          release: 0.5,
          feedback: 0.6,
          pitchAmount: -12,
          pitchAttack: 0.03,
          pitchRelease: 0.1,
        },
        {
          ratio: 1,
          detune: 0,
          level: 0.8,
          attack: 0.01,
          release: 0.5,
          feedback: 0,
        },
        {
          ratio: 2,
          detune: 0,
          level: 0.6,
          attack: 0.01,
          release: 0.5,
          feedback: 0,
        },
        {
          ratio: 3,
          detune: 0,
          level: 0.4,
          attack: 0.01,
          release: 0.5,
          feedback: 0,
        },
        {
          ratio: 1,
          detune: 0,
          level: 0.2,
          attack: 0.01,
          release: 0.5,
          feedback: 0,
        },
        {
          ratio: 0.5,
          detune: 0,
          level: 0.3,
          attack: 0.01,
          release: 0.5,
          feedback: 0,
        },
      ],
    },
  },

  Bell: {
    "FM Bell'ish": {
      algorithm: 1,
      glide: 0,
      volume: 0.5,
      delayGain: 0.4,
      delayFeedback: 0.3,
      delayTime: 0.2,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 1,
          detune: 0,
          level: 1,
          attack: 0.01,
          release: 2,
          feedback: 0.4,
          pitchAmount: 12,
          pitchAttack: 0.3,
          pitchRelease: 0.2,
        },
        {
          ratio: 2,
          detune: 0,
          level: 0.8,
          attack: 0.01,
          release: 2,
          feedback: 0,
        },
        {
          ratio: 3,
          detune: 0,
          level: 0.6,
          attack: 0.01,
          release: 2,
          feedback: 0,
        },
        {
          ratio: 4,
          detune: 0,
          level: 0.4,
          attack: 0.01,
          release: 2,
          feedback: 0,
        },
        {
          ratio: 5,
          detune: 0,
          level: 0.3,
          attack: 0.01,
          release: 2,
          feedback: 0,
        },
        {
          ratio: 6,
          detune: 0,
          level: 0.2,
          attack: 0.01,
          release: 2,
          feedback: 0,
        },
      ],
    },
    "Tiny Bell": {
      algorithm: 2,
      glide: 0,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0.2,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 1,
          detune: 0,
          level: 0.9,
          attack: 0.01,
          release: 2.5,
          feedback: 0,
          pitchAmount: 10,
          pitchAttack: 0.4,
          pitchRelease: 0.3,
        },
        {
          ratio: 2.1,
          detune: 0,
          level: 0.8,
          attack: 0.01,
          release: 2.5,
          feedback: 0,
        },
        {
          ratio: 3.9,
          detune: 0,
          level: 0.7,
          attack: 0.01,
          release: 2.5,
          feedback: 0,
        },
        {
          ratio: 6.1,
          detune: 0,
          level: 0.5,
          attack: 0.01,
          release: 2.5,
          feedback: 0,
        },
        {
          ratio: 8,
          detune: 0,
          level: 0.3,
          attack: 0.01,
          release: 2.5,
          feedback: 0,
        },
        {
          ratio: 10,
          detune: 0,
          level: 0.2,
          attack: 0.01,
          release: 2.5,
          feedback: 0,
        },
      ],
    },
  },

  Pad: {
    "Warmer Pad": {
      algorithm: 32,
      glide: 0,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.15,
      distortionMix: 0.3,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0.5,
      tremoloDelay: 0,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.7,
      operators: [
        {
          ratio: 1,
          detune: -2,
          level: 0.8,
          attack: 0.3,
          release: 4,
          feedback: 0.6,
          pitchAmount: -2,
          pitchAttack: 1,
          pitchRelease: 1,
        },
        {
          ratio: 1.01,
          detune: 2,
          level: 0.8,
          attack: 0.3,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 2,
          detune: 1,
          level: 0.6,
          attack: 0.3,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 2.01,
          detune: -1,
          level: 0.6,
          attack: 0.3,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 3,
          detune: 0,
          level: 0.4,
          attack: 0.3,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 3.01,
          detune: 0,
          level: 0.4,
          attack: 0.3,
          release: 4,
          feedback: 0,
        },
      ],
    },
    "Glassy Pad": {
      algorithm: 3,
      glide: 0,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 4,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 1,
          detune: 0,
          level: 0.8,
          attack: 0.5,
          release: 5,
          feedback: 0,
          pitchAmount: 6,
          pitchAttack: 1.2,
          pitchRelease: 0.5,
        },
        {
          ratio: 2,
          detune: 2,
          level: 0.7,
          attack: 0.5,
          release: 5,
          feedback: 0.5,
        },
        {
          ratio: 3,
          detune: -2,
          level: 0.6,
          attack: 0.5,
          release: 5,
          feedback: 0,
        },
        {
          ratio: 4,
          detune: 0,
          level: 0.5,
          attack: 0.5,
          release: 5,
          feedback: 0,
        },
        {
          ratio: 5,
          detune: 1,
          level: 0.3,
          attack: 0.5,
          release: 5,
          feedback: 0,
        },
        {
          ratio: 6,
          detune: -1,
          level: 0.2,
          attack: 0.5,
          release: 5,
          feedback: 0,
        },
      ],
    },
  },

  Keys: {
    "Electric Piano": {
      algorithm: 2,
      glide: 0,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 1,
          detune: 0,
          level: 1,
          attack: 0.01,
          release: 1,
          feedback: 0.6,
          pitchAmount: -2,
          pitchAttack: 0.2,
          pitchRelease: 0.2,
        },
        {
          ratio: 2,
          detune: 0,
          level: 0.7,
          attack: 0.01,
          release: 1,
          feedback: 0,
        },
        {
          ratio: 3,
          detune: 0,
          level: 0.5,
          attack: 0.01,
          release: 1,
          feedback: 0,
        },
        {
          ratio: 4,
          detune: 0,
          level: 0.3,
          attack: 0.01,
          release: 1,
          feedback: 0,
        },
        {
          ratio: 5,
          detune: 0,
          level: 0.2,
          attack: 0.01,
          release: 1,
          feedback: 0,
        },
        {
          ratio: 6,
          detune: 0,
          level: 0.1,
          attack: 0.01,
          release: 1,
          feedback: 0,
        },
      ],
    },
    "Digi Clav": {
      algorithm: 6,
      glide: 0,
      volume: 0.5,
      delayGain: 0.3,
      delayFeedback: 0.5,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 1,
          detune: 0,
          level: 1,
          attack: 0.01,
          release: 1.5,
          feedback: 0.6,
          pitchAmount: -4,
          pitchAttack: 0.1,
          pitchRelease: 0.2,
        },
        {
          ratio: 3,
          detune: 0,
          level: 0.8,
          attack: 0.01,
          release: 1.5,
          feedback: 0,
        },
        {
          ratio: 5,
          detune: 0,
          level: 0.6,
          attack: 0.01,
          release: 1.5,
          feedback: 0,
        },
        {
          ratio: 7,
          detune: 0,
          level: 0.4,
          attack: 0.01,
          release: 1.5,
          feedback: 0,
        },
        {
          ratio: 9,
          detune: 0,
          level: 0.2,
          attack: 0.01,
          release: 1.5,
          feedback: 0,
        },
        {
          ratio: 11,
          detune: 0,
          level: 0.1,
          attack: 0.01,
          release: 1.5,
          feedback: 0,
        },
      ],
    },
  },
  FX: {
    "Metal Hit": {
      algorithm: 1,
      glide: 0,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 1,
      pannerDepth: 0,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        {
          ratio: 1,
          detune: 0,
          level: 1,
          attack: 0.001,
          release: 0.3,
          feedback: 1.0,
          pitchAmount: 18,
          pitchAttack: 0.01,
          pitchRelease: 0.2,
        },
        {
          ratio: 5,
          detune: 0,
          level: 1,
          attack: 0.001,
          release: 0.3,
          feedback: 0,
        },
        {
          ratio: 7,
          detune: 0,
          level: 1,
          attack: 0.001,
          release: 0.3,
          feedback: 0,
        },
        {
          ratio: 9,
          detune: 0,
          level: 1,
          attack: 0.001,
          release: 0.3,
          feedback: 0,
        },
        {
          ratio: 11,
          detune: 0,
          level: 1,
          attack: 0.001,
          release: 0.3,
          feedback: 0,
        },
        {
          ratio: 13,
          detune: 0,
          level: 1,
          attack: 0.001,
          release: 0.3,
          feedback: 0,
        },
      ],
    },
    "Noise Drone": {
      algorithm: 4,
      glide: 0.3,
      volume: 0.5,
      delayGain: 0,
      delayFeedback: 0,
      delayTime: 0.4,
      pannerRate: 4,
      pannerDepth: 0.4,
      pannerDirection: 0,
      distortionDrive: 400,
      distortionPre: 0.5,
      distortionMix: 0,
      pitchLFORate: 2.5,
      pitchLFODepth: 0.3,
      pitchLFOType: "sine",
      filterType: "lowpass",
      filterFreq: 20000,
      filterQ: 0.2,
      tremoloRate: 5,
      tremoloDepth: 0,
      tremoloDelay: 0.2,
      reverb: 0.4,
      pitchEnv: {
        delay: 0,
        attack: 0.1,
        decay: 0.2,
        sustain: 0.5,
        release: 0.5,
        depth: 0,
      },
      stereoWidth: 0.5,
      operators: [
        { ratio: 1, detune: 0, level: 1, attack: 1.0, release: 4, feedback: 0 },
        {
          ratio: 1.1,
          detune: 10,
          level: 0.9,
          attack: 1.0,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 1.2,
          detune: -10,
          level: 0.8,
          attack: 1.0,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 1.3,
          detune: 15,
          level: 0.7,
          attack: 1.0,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 1.4,
          detune: -15,
          level: 0.6,
          attack: 1.0,
          release: 4,
          feedback: 0,
        },
        {
          ratio: 1.5,
          detune: 20,
          level: 0.5,
          attack: 1.0,
          release: 4,
          feedback: 0.4,
        },
      ],
    },
  },
};

export function applyPreset(preset) {
  const {
    algorithm,
    volume,
    glide,
    operators,
    delayGain,
    delayFeedback,
    delayTime,
    pannerRate,
    pannerDepth,
    pannerDirection,
    distortionDrive,
    distortionPre,
    distortionMix,
    pitchLFORate,
    pitchLFODepth,
    pitchLFOType,
    filterType,
    filterFreq,
    filterQ,
    tremoloRate,
    tremoloDepth,
    tremoloDelay,
    reverb,
    pitchEnv,
    stereoWidth,
  } = preset;

  const algoSelect = document.getElementById("algorithm-select");
  algoSelect.value = algorithm;
  algoSelect.dispatchEvent(new Event("change"));

  if (glide !== undefined) {
    const el = document.getElementById("glide-time");
    el.value = glide;
    el.dispatchEvent(new Event("input"));
  }

  if (volume !== undefined) {
    const el = document.getElementById("master-volume");
    el.value = volume;
    el.dispatchEvent(new Event("input"));
  }

  if (delayGain !== undefined) {
    const el = document.getElementById("delay-gain");
    el.value = delayGain;
    el.dispatchEvent(new Event("input"));
  }

  if (delayFeedback !== undefined) {
    const el = document.getElementById("delay-feedback");
    el.value = delayFeedback;
    el.dispatchEvent(new Event("input"));
  }

  if (delayTime !== undefined) {
    const el = document.getElementById("delay-time");
    el.value = delayTime;
    el.dispatchEvent(new Event("input"));
  }

  if (pannerRate !== undefined) {
    const el = document.getElementById("panner-rate");
    el.value = pannerRate;
    el.dispatchEvent(new Event("input"));
  }

  if (pannerDepth !== undefined) {
    const el = document.getElementById("panner-depth");
    el.value = pannerDepth;
    el.dispatchEvent(new Event("input"));
  }

  if (pannerDirection !== undefined) {
    const el = document.getElementById("panner-modulation");
    el.value = pannerDirection;
    el.dispatchEvent(new Event("input"));
  }

  if (distortionDrive !== undefined) {
    const el = document.getElementById("distortion-amount");
    el.value = distortionDrive;
    el.dispatchEvent(new Event("input"));
  }

  if (distortionPre !== undefined) {
    const el = document.getElementById("distortion-pregain");
    el.value = distortionPre;
    el.dispatchEvent(new Event("input"));
  }

  if (distortionMix !== undefined) {
    const el = document.getElementById("distortion-mix");
    el.value = distortionMix;
    el.dispatchEvent(new Event("input"));
  }

  if (pitchLFORate !== undefined) {
    const el = document.getElementById("pitch-lfo-rate");
    el.value = pitchLFORate;
    el.dispatchEvent(new Event("input"));
  }
  if (pitchLFODepth !== undefined) {
    const el = document.getElementById("pitch-lfo-depth");
    el.value = pitchLFODepth;
    el.dispatchEvent(new Event("input"));
  }

  if (pitchLFOType !== undefined) {
    const el = document.getElementById("pitch-lfo-type");
    el.value = pitchLFOType;
    el.dispatchEvent(new Event("input"));
  }

  const filterSelect = document.getElementById("filter-type");
  filterSelect.value = filterType;
  filterSelect.dispatchEvent(new Event("change"));

  if (filterFreq !== undefined) {
    const el = document.getElementById("filter-frequency");
    el.value = filterFreq;
    el.dispatchEvent(new Event("input"));
  }

  if (filterQ !== undefined) {
    const el = document.getElementById("filter-q");
    el.value = filterQ;
    el.dispatchEvent(new Event("input"));
  }

  if (tremoloRate !== undefined) {
    const el = document.getElementById("tremolo-rate");
    el.value = tremoloRate;
    el.dispatchEvent(new Event("input"));
  }

  if (tremoloDepth !== undefined) {
    const el = document.getElementById("tremolo-depth");
    el.value = tremoloDepth;
    el.dispatchEvent(new Event("input"));
  }

  if (tremoloDelay !== undefined) {
    const el = document.getElementById("tremolo-delay");
    el.value = tremoloDelay;
    el.dispatchEvent(new Event("input"));
  }

  if (reverb !== undefined) {
    const el = document.getElementById("reverb-gain");
    el.value = reverb;
    el.dispatchEvent(new Event("input"));
  }

  if (pitchEnv) {
    const keys = ["delay", "attack", "decay", "sustain", "release", "depth"];
    keys.forEach((key) => {
      if (pitchEnv[key] !== undefined) {
        const el = document.getElementById(`pitch-env-${key}`);
        el.value = pitchEnv[key];
        el.dispatchEvent(new Event("input"));
      }
    });

    if (stereoWidth !== undefined) {
      const el = document.getElementById("stereo-width");
      el.value = stereoWidth;
      el.dispatchEvent(new Event("input"));
    }
  }

  // 🎛️ Set operator values
  for (let i = 1; i <= 6; i++) {
    const p = operators[i - 1];
    [
      "ratio",
      "detune",
      "level",
      "attack",
      "release",
      "feedback",
      "pitchAmount",
      "pitchAttack",
      "pitchRelease",
    ].forEach((param) => {
      const input = document.getElementById(`${param}-${i}`);
      if (!input || p[param] === undefined) return;
      input.value = p[param];
      input.dispatchEvent(new Event("input"));

      const display = document.getElementById(`${param}-val-${i}`);
      if (display) display.textContent = p[param];
    });
  }
}

export function createOperatorControls(container) {
  container.innerHTML = "";

  const params = [
    { id: "ratio", label: "Ratio", min: 0.1, max: 10, step: 0.1, value: 1 },
    { id: "detune", label: "Detune", min: -50, max: 50, step: 1, value: 0 },
    { id: "level", label: "Level", min: 0, max: 2, step: 0.1, value: 1 },
    { id: "attack", label: "Attack", min: 0, max: 2, step: 0.01, value: 0.01 },
    { id: "release", label: "Release", min: 0, max: 5, step: 0.01, value: 0.5 },
    {
      id: "pitch-amount",
      label: "P Amt",
      min: -24,
      max: 24,
      step: 1,
      value: 0,
    },
    {
      id: "pitch-attack",
      label: "P Atk",
      min: 0,
      max: 2,
      step: 0.01,
      value: 0.1,
    },
    {
      id: "pitch-release",
      label: "P Rel",
      min: 0,
      max: 2,
      step: 0.01,
      value: 0.1,
    },
    {
      id: "feedback",
      label: "FB",
      min: 0,
      max: 2,
      step: 0.01,
      value: 0,
    },
  ];

  function announce(msg) {
    const region = document.getElementById("aria-status");
    if (region) {
      region.textContent = "";
      setTimeout(() => {
        region.textContent = msg;
      }, 10);
    }
  }

  for (let i = 1; i <= 6; i++) {
    // Create and append the label
    const label = document.createElement("div");
    label.classList.add("operator-label");
    label.textContent = `Operator ${i}`;

    // Create operator block
    const opDiv = document.createElement("div");
    opDiv.classList.add("operator-block");
    opDiv.classList.add("panel");
    const controlRow = document.createElement("div");
    controlRow.classList.add("operator-controls-row");
    controlRow.classList.add("panel");

    params.forEach((param) => {
      const wrapper = document.createElement("div");
      wrapper.className = "slider-div panel";

      const labelEl = document.createElement("label");
      labelEl.setAttribute("for", `${param.id}-${i}`);
      labelEl.textContent = param.label;
      labelEl.className = "lcd-text";

      const rangeWrapper = document.createElement("div");
      rangeWrapper.className = "range-knob-wrapper";
      rangeWrapper.style.border = "none";

      const input = document.createElement("input");
      input.setAttribute("type", "range");
      input.setAttribute("aria-label", `${param.label} Operator ${i}`);
      input.setAttribute("id", `${param.id}-${i}`);
      input.setAttribute("min", param.min);
      input.setAttribute("max", param.max);
      input.setAttribute("step", param.step);
      input.setAttribute("value", param.value);

      if (param.id === "feedback") {
        input.classList.add("feedback-slider");
        input.setAttribute("data-op", i);
      }

      const knob = document.createElement("div");
      knob.className = "range-knob";

      const valueDisplay = document.createElement("span");
      valueDisplay.setAttribute("id", `${param.id}-val-${i}`);
      valueDisplay.textContent = param.value;
      valueDisplay.className = "lcd-text";

      input.addEventListener("input", () => {
        valueDisplay.textContent = input.value;
      });

      // MIDI Learn Button
      const learnButton = document.createElement("button");
      learnButton.className = "learn-button lcd-button";
      learnButton.textContent = "Learn";
      learnButton.title = "Click to assign a MIDI CC to this parameter";
      learnButton.style.marginTop = "4px";
      learnButton.style.fontSize = "0.75em";
      learnButton.setAttribute("aria-label", `${param.label} Learn CC Button`);

      learnButton.addEventListener("click", () => {
        document
          .querySelectorAll(".learn-button")
          .forEach((btn) => btn.classList.remove("flicker"));

        // Set the learningParamId
        if (typeof window.setLearningParamId === "function") {
          window.setLearningParamId(`${param.id}-${i}`);
        } else {
          console.warn("setLearningParamId is not available globally.");
        }
        announce(`Ready to map MIDI CC to: ${param.id}`);
        learnButton.classList.add("flicker");
      });

      rangeWrapper.appendChild(input);
      rangeWrapper.appendChild(knob);

      wrapper.appendChild(labelEl);
      wrapper.appendChild(rangeWrapper);
      wrapper.appendChild(valueDisplay);
      wrapper.appendChild(learnButton);

      controlRow.appendChild(wrapper);
    });

    opDiv.appendChild(controlRow);

    opDiv.appendChild(label);
    opDiv.appendChild(controlRow);
    container.appendChild(opDiv);
  }

  for (let i = 1; i <= 6; i++) {
    ["ratio", "detune", "level", "attack", "release"].forEach((param) => {
      const input = document.getElementById(`${param}-${i}`);
      const span = document.getElementById(`${param}-val-${i}`);
      input.addEventListener("input", () => {
        span.textContent = input.value;
      });
    });
  }
}

const LOCAL_MIDI_MAP_KEY = "BXmidiCCMappings";

export let learningParamId = null;

export function setLearningParamId(id) {
  learningParamId = id;
  document
    .querySelectorAll(".learn-button")
    .forEach((btn) => btn.classList.remove("flicker"));
  console.log(`🎛️ Ready to map MIDI CC to: ${id}`);
}
window.setLearningParamId = setLearningParamId;

export function getOperatorParams() {
  const params = [];
  for (let i = 1; i <= 6; i++) {
    params.push({
      ratio: parseFloat(document.getElementById(`ratio-${i}`).value),
      detune: parseFloat(document.getElementById(`detune-${i}`).value),
      level: parseFloat(document.getElementById(`level-${i}`).value),
      attack: parseFloat(document.getElementById(`attack-${i}`).value),
      release: parseFloat(document.getElementById(`release-${i}`).value),
      pitchAmount: parseFloat(
        document.getElementById(`pitch-amount-${i}`).value
      ),
      pitchAttack: parseFloat(
        document.getElementById(`pitch-attack-${i}`).value
      ),
      pitchRelease: parseFloat(
        document.getElementById(`pitch-release-${i}`).value
      ),
      feedback: parseFloat(
        document.getElementById(`feedback-${i}`)?.value ?? 0
      ),
    });
  }
  return params;
}

const LOCAL_PRESET_KEY = "BXuserPresets";

export function savePresetToLocal(name, preset) {
  const all = JSON.parse(localStorage.getItem(LOCAL_PRESET_KEY) || "{}");
  all[name] = preset;
  localStorage.setItem(LOCAL_PRESET_KEY, JSON.stringify(all));
}

export function getLocalPresets() {
  return JSON.parse(localStorage.getItem(LOCAL_PRESET_KEY) || "{}");
}

export function deleteLocalPreset(name) {
  const all = getLocalPresets();
  delete all[name];
  localStorage.setItem(LOCAL_PRESET_KEY, JSON.stringify(all));
}

export function exportLocalPresets(filename = "my-presets.json") {
  const all = getLocalPresets();
  const blob = new Blob([JSON.stringify(all, null, 2)], {
    type: "application/json",
  });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

export function collectCurrentPreset() {
  return {
    algorithm: parseInt(document.getElementById("algorithm-select").value),
    glide: parseInt(document.getElementById("glide-time").value),
    volume: parseFloat(document.getElementById("master-volume").value),
    delayGain: parseFloat(document.getElementById("delay-gain").value),
    delayFeedback: parseFloat(document.getElementById("delay-feedback").value),
    delayTime: parseFloat(document.getElementById("delay-time").value),
    pannerRate: parseFloat(document.getElementById("panner-rate").value),
    pannerDepth: parseFloat(document.getElementById("panner-depth").value),
    pannerDirection: parseFloat(
      document.getElementById("panner-modulation").value
    ),
    distortionDrive: parseFloat(
      document.getElementById("distortion-amount").value
    ),
    distortionPre: parseFloat(
      document.getElementById("distortion-pregain").value
    ),
    distortionMix: parseFloat(document.getElementById("distortion-mix").value),
    pitchLFORate: parseFloat(document.getElementById("pitch-lfo-rate").value),
    pitchLFODepth: parseFloat(document.getElementById("pitch-lfo-depth").value),
    pitchLFOType: document.getElementById("pitch-lfo-type").value,
    filterType: document.getElementById("filter-type").value,
    filterFreq: parseFloat(document.getElementById("filter-frequency").value),
    filterQ: parseFloat(document.getElementById("filter-q").value),
    tremoloRate: parseFloat(document.getElementById("tremolo-rate").value),
    tremoloDepth: parseFloat(document.getElementById("tremolo-depth").value),
    tremoloDelay: parseFloat(document.getElementById("tremolo-delay").value),
    reverb: parseFloat(document.getElementById("reverb-gain").value),
    stereoWidth: parseFloat(document.getElementById("stereo-width").value),
    pitchEnv: {
      delay: parseFloat(document.getElementById("pitch-env-delay").value),
      attack: parseFloat(document.getElementById("pitch-env-attack").value),
      decay: parseFloat(document.getElementById("pitch-env-decay").value),
      sustain: parseFloat(document.getElementById("pitch-env-sustain").value),
      release: parseFloat(document.getElementById("pitch-env-release").value),
      depth: parseFloat(document.getElementById("pitch-env-depth").value),
    },
    operators: getOperatorParams(),
  };
}

window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    const firstCategory = Object.keys(PRESETS)[0];
    const firstPresetName = Object.keys(PRESETS[firstCategory])[0];
    const firstPreset = PRESETS[firstCategory][firstPresetName];

    applyPreset(firstPreset);
  }, 100);
});
